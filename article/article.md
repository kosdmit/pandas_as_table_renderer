# Pandas НЕ для анализа данных

## Введение

В среде питонистов библиотека Pandas пользуется большой популярностью и по большей мере известна в контексте DataSciense и анализа данных, как инструмент для работы с большими объемами данных. Как следует из русскоязычной википедии: "**pandas** — это программная библиотека на языке Python для обработки и анализа данных." Наверное не один Jupyter ноутбук не обходится без использования пандосовских DataFrame'ов. На самом деле, DataFrame пандас позволяет не только всячески манипулировать данными, но и выводить их в нужном формате, предоставляя широкие возможности для кастомизации. Например, использовали ли вы объекты класса `Styler` входящего в состав Pandas? Мне показалось интересным взлянуть на Pandas с этой стороны.

На практике очень многие бизнес-задачи подразумевают работу с двумерными массивами данных или проще говоря - таблицами. Как следствие, возникает потребность представлять такие данные в виде удобном для восприятия человеком. Поэтому будет интерсено поговорить о подходах к рендеренгу таблиц в контексте веб-приложения на Python.

Актуальности данной теме добавляет тот факт, что подобной информации довольно мало как в интернете, так и в профессиональной литературе (возможность рендеринга таблиц в html не упоминается и в указанной выше [статье](https://ru.wikipedia.org/wiki/Pandas) википедии).

## Проблема

Мы хотим отображать имеющиеся данные в виде html таблицы.

Часто одни и те же данные нужно представить в разных вариациях, например отобразить на странице сайта, в email сообщении или формате Excel. Когда я начинал работу над одним из прошлых проектов, я столкнулся с трудно-поддерживаемыми, толстыми шаблонами веб-страниц, которые содержали html разметку для отображения таблиц с большим количеством данных. К тому же, html шаблоны могли иметь различные вариации например для email уведомлений и тд. Такой подход вызывает трудности при изменении структуры таблицы или данных.

*Все последующие манипуляции будем проводить в контексте приложения на Django. В качестве адаптера БД имеется модель `Customer`, в качестве http представления имеем - `CustomerListView`.
Код проекта с начальными условиями доступен на GitHub - [commit# 8fdf785](https://github.com/kosdmit/pandas_as_table_renderer/tree/8fdf785e0e715329d7390cae17c68b23cf8562a0).*

Решение в лоб - передать в контекст страницы итерируемый объект содержащий строки данных, и средствами шаблонизатора итерироваться по нему формируя html код таблицы строка за строкой.

✅ Не требует использования дополнительных библиотек
❌ Структура таблицы формируется в html шаблонах
❌ "Толстые" шаблоны таблиц
❌ Затруднена поддержка и внесение изменений
❌ Повторение работы при необходимости добавить вариацию таблицы (email, Excel и тд.)

## Используем Pandas

Поскольку pandas уже входил в технологический стек проекта, было принято решение задействовать эту библиотеку для рендеринга таблиц в html.

DataFrame это внутренняя структура Pandas для хранения таблицы и проведения операций над ней. Создадим новый объект DataFrame, передав нужные данные в конструктор класса, и отрендерим html воспользовавшись методом датафрейма - `to_html()`:

```python
# views.py

class CustomerListView(ListView):
    model = Customer
    paginate_by = 10

    def get_context_data(self, *, object_list=None, **kwargs):
        context = super().get_context_data(**kwargs)
        context['table'] = self.get_html_table(context['object_list'])
        return context

    def get_html_table(self, object_list: QuerySet):
        df = pd.DataFrame(
            data=object_list.values_list(),
            columns=[field.verbose_name for field in object_list.model._meta.get_fields()],
        )
        return df.to_html(index=False)
```

Метод `get_html_table()` возвращает html код таблицы принимая на вход объект типа QuerySet - `object_list` из контекcта ListView Django.

Конструктор класса DataFrame может принимать итерируемый объект который содержит входные данные и список наименований столбцов.
Поэтому передаем данные в DataFrame воспользовавшись методом QuerySet.values_list() для представления объектов БД в виде кортежей со значениями атрибутов объекта.

Таким образом, мы получили html таблицу написав миниатюрный метод состоящий из нескольких строк кода. Хотя, стоит отметить, что в таком виде таблица не будет иметь какой либо стилизации. Убедимся в этом добавив полученный html в шаблон страницы, и взглянем на неё:

```html
# customer_list.html

{% extends 'base.html' %}

{% block content %}
  <div class="col-6">
    {{ table|safe }}
  </div>
{% endblock %}
```

![Изображение 1. Таблица без стилизации](./assets/1.PNG)

*Код проекта из этого раздела доступен на GitHub - [commit# ](https://github.com/kosdmit/pandas_as_table_renderer/).*
